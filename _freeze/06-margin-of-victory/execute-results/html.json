{
  "hash": "d81af1626f5c696102afc9ced86f30f9",
  "result": {
    "engine": "knitr",
    "markdown": "# Margin of Victory\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"tidyverse\"); theme_set(theme_bw())\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'purrr' was built under R version 4.4.1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4.9000     ✔ readr     2.1.5     \n✔ forcats   1.0.0          ✔ stringr   1.5.1     \n✔ ggplot2   3.5.1          ✔ tibble    3.2.1     \n✔ lubridate 1.9.3          ✔ tidyr     1.3.1     \n✔ purrr     1.0.4          \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(\"ggResidpanel\")\n```\n:::\n\n\nA simple example of margin-of-victory data is this fictitious collection of 4 \nteams that have played 5 games. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- tribble(\n  ~home, ~away, ~home_score, ~away_score, \n      1,     2,          21,           7,\n      2,     3,          13,          14,\n      4,     1,           3,          28,\n      3,     4,          31,           0,\n      1,     3,          42,          10\n) |>\n  mutate(\n    margin = home_score - away_score\n  )\n```\n:::\n\n\nFor the analysis that follows, \nwe will construct a model matrix $X$ where \n$X_{g,t} = 1$ if team $t$ is the home team in game $g$,  \n$X_{g,t} = -1$ if team $t$ is the away team in game $g$,\n$X_{g,t} = 0$ otherwise.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconstruct_model_matrix <- function(d) {\n  n_games <- nrow(d)\n  n_teams <- length(unique(c(d$home, d$away)))\n  \n  m <- matrix(0, \n              nrow = n_games, \n              ncol = n_teams)\n  \n  for (g in 1:n_games) {\n    m[g, d$home[g]] <-  1\n    m[g, d$away[g]] <- -1\n  }\n  \n  return(m)\n}\n\nX <- construct_model_matrix(d)\nX\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     [,1] [,2] [,3] [,4]\n[1,]    1   -1    0    0\n[2,]    0    1   -1    0\n[3,]   -1    0    0    1\n[4,]    0    0    1   -1\n[5,]    1    0   -1    0\n```\n\n\n:::\n:::\n\n\n\n## Model\n\nA model for the margin of victory is \n\n$$M_g = \\eta + \\theta_{H[g]} - \\theta_{A[g]} + \\epsilon_g$$\n\nwhere, for game $g$,\n\n- $M_g$ is the margin of victory,\n- $H[g]$ is the ID for the home team, \n- $A[g]$ is the ID for the away team,\n- $\\epsilon_g$ is a random error.\n\nThis error arises because if two teams play each other repeatedly we would \nexpect that the score in their games would be random around the expected\nmargin of victory.\n\nThe parameters are \n\n- $\\eta$ is the home field advantage \n- $\\theta_t$ is the strength of team $t$. \n\nThe expected margin of victory when team $H$ is at home playing\nagainst team $A$ is \n\n$$E[M] = \\eta + \\theta_{H} - \\theta_{A}.$$\n\n\n### Identifiability\n\nIn this model, \nwhen two teams play each other, the margin of victory is expected to be the \nhome field advantage $\\eta$ plus the difference in strengths between the two\nteams $\\theta_H - \\theta_A$.\nThus, the individual $\\theta$s are not *identifiable*, but only there \ndifference is. \nAnother way to state this is that we could add a constant to all of the \nteam strengths and it would not change the distribution of the margin of \nvictory since \n$$(\\theta_H + c) - (\\theta_A + c) = \\theta_H - \\theta_A.$$\nEven though the individual $\\theta$ are not identifiable,\nthe differences are. \n\n::: {.callout-note}\n## Identifiable\nParameters (or functions of parameters) within a model are said to be \n*identifiable* if they can theoretically be estimated with an infinite amount \nof (the right kind of) data. \nThat is, as you collect more and more data, the uncertainty in the parameter\ndecreases to zero.\n:::\n\n\n### Regression\n\n\nIf we assume $\\epsilon_i \\stackrel{ind}{\\sim} N(0,\\sigma^2)$,\nthen this is a linear regression model. \nTo see how it is a linear regression model, \nwe use the model matrix above and construct the following model\n\n$$M_i = \\eta + \\theta_1 X_{i,1} + \\theta_2 X_{i,2} + \n\\theta_3 X_{i,3} + \\theta_4 X_{i,4} + \\epsilon_i, \n\\quad \\epsilon_i \\stackrel{ind}{\\sim} N(0,\\sigma^2)$$.\n\nThus, we can estimate the parameters in this model using linear regression.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm <- lm(d$margin ~ X) # intercept (home-field advantage) is included automatically\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = d$margin ~ X)\n\nResiduals:\n     1      2      3      4      5 \n-7.917 -7.917  2.639  2.639 10.556 \n\nCoefficients: (1 not defined because of singularities)\n            Estimate Std. Error t value Pr(>|t|)\n(Intercept)    7.389      7.464   0.990    0.503\nX1            35.028     12.656   2.768    0.221\nX2            20.500     15.833   1.295    0.419\nX3            20.972     12.656   1.657    0.346\nX4                NA         NA      NA       NA\n\nResidual standard error: 15.83 on 1 degrees of freedom\nMultiple R-squared:  0.8904,\tAdjusted R-squared:  0.5615 \nF-statistic: 2.707 on 3 and 1 DF,  p-value: 0.4137\n```\n\n\n:::\n:::\n\n\n\n\nFrom this model, we can obtain individual values for $\\theta$.\nThe estimated values are \n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoef(m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n(Intercept)          X1          X2          X3          X4 \n   7.388889   35.027778   20.500000   20.972222          NA \n```\n\n\n:::\n:::\n\n\nWith these data, the estimated home field advantage is \n$\\eta = 7.3888889.\nThe estimated ability for the teams are \n\n::: {.cell}\n\n```{.r .cell-code}\ncoef(m)[-1]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X1       X2       X3       X4 \n35.02778 20.50000 20.97222       NA \n```\n\n\n:::\n:::\n\n\nThe fourth team has an estimated value of $\\theta_4 = NA$,\ni.e. not available. \nThe reason for this is the identifiability issue above. \n\nHere, the $NA$ can be replaced by 0. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nteam_ability <- coef(m)[-1]\nteam_ability[4] <- 0\nteam_ability\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X1       X2       X3       X4 \n35.02778 20.50000 20.97222  0.00000 \n```\n\n\n:::\n:::\n\n\nUsing these team ability estimates, we can compute the expected point \ndifference between the teams. \nFor example, on a neutral court, the expected point difference between team\n1 and team 2 is\n\n::: {.cell}\n\n```{.r .cell-code}\nteam_ability[1] - team_ability[2] # expected point difference on a neutral court\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X1 \n14.52778 \n```\n\n\n:::\n:::\n\nSo Team 1 is expected to beat Team 2 by \n15\npoints. \n\n\n### Prediction\n\nIn addition to the expected point difference,\nyou can use this model to predict the probability that one team beats the \nother team. \nIn order to perform this prediction, we need to know the variability around\nthe expected point spread. \nWe can extract this information from the regression model.\nThe estimated residual standard deviation is \n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(m)$sigma\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 15.83333\n```\n\n\n:::\n:::\n\n\nPrediction in a regression model utilizes a $t$ distribution with degrees\nof freedom equal to the number of observations minus the number of teams. \nThis is given in the R output.\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(m)$df[2] \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1\n```\n\n\n:::\n:::\n\nThus to calculate the probability that Team 1 beats Team 2 on a neutral court\nwe calculate\n$$P\\left(T_v < \\frac{\\theta_1 - \\theta_2}{\\hat\\sigma}\\right).$$\nIn R code, we have \n\n\n::: {.cell}\n\n```{.r .cell-code}\npt( (team_ability[1] - team_ability[2]) / summary(m)$sigma, summary(m)$df[2] )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       X1 \n0.7363208 \n```\n\n\n:::\n:::\n\n\n\n### Transitivity\n\nOne drawback of these types of models is that the model is transitive, \nbut this may not reflect reality. \nThe transitivity property in this model is \n$$\\theta_A > \\theta_B \\quad\\&\\quad \\theta_B > \\theta_C \\,\\implies\\, \\theta_A > \\theta_C.$$\nIn words, this means that if Team A is better than Team B and \nTeam B is better than Team C, \nthen Team A must be better than Team C. \nThis precludes the possibility that Team C could match up well against Team A. \n\nAs an example, consider the following set of teams and games.\n\n::: {.cell}\n\n```{.r .cell-code}\nd2 <- tribble(\n  ~home, ~away, ~margin, \n      1,     2,     100,   \n      2,     3,      90, \n      3,     1,      95,\n  \n      2,     1,    -100,   \n      3,     2,     -90, \n      1,     3,     -95\n) \n```\n:::\n\n\nIf these were data for basketball games, \nwe would expect that \nTeam 1 has a high probability of beating Team 2,\nTeam 2 has a high probability of beating Team 3, and\nTeam 3 has a high probability of beating Team 1. \n\nFitting the model above and estimating the probstrengths tells a different\nstory.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nX2 <- construct_model_matrix(d2)\n\nm2 <- lm(d2$margin ~ X2)\nsummary(m2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = d2$margin ~ X2)\n\nResiduals:\n  1   2   3   4   5   6 \n 95  95  95 -95 -95 -95 \n\nCoefficients: (1 not defined because of singularities)\n              Estimate Std. Error t value Pr(>|t|)\n(Intercept)  3.599e-15  5.485e+01   0.000    1.000\nX21          2.220e-15  7.757e+01   0.000    1.000\nX22         -5.000e+00  7.757e+01  -0.064    0.953\nX23                 NA         NA      NA       NA\n\nResidual standard error: 134.4 on 3 degrees of freedom\nMultiple R-squared:  0.001843,\tAdjusted R-squared:  -0.6636 \nF-statistic: 0.00277 on 2 and 3 DF,  p-value: 0.9972\n```\n\n\n:::\n:::\n\n\nWe can already see issues here since none of the coefficients are \nsignificantly different from zero. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate team strengths\nteam_ability <- coef(m2)[-1]\nteam_ability[3] <- 0\nteam_ability\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          X21           X22           X23 \n 2.220446e-15 -5.000000e+00  0.000000e+00 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Calculate probstrengths\npt( (team_ability[1] - team_ability[2]) / summary(m2)$sigma, summary(m2)$df[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X21 \n0.5136747 \n```\n\n\n:::\n\n```{.r .cell-code}\npt( (team_ability[1] - team_ability[3]) / summary(m2)$sigma, summary(m2)$df[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nX21 \n0.5 \n```\n\n\n:::\n\n```{.r .cell-code}\npt( (team_ability[2] - team_ability[3]) / summary(m2)$sigma, summary(m2)$df[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X22 \n0.4863253 \n```\n\n\n:::\n:::\n\n\n\n\n### Estimability\n\nConsider this set of teams and games\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd3 <- tribble(\n  ~home, ~away, ~margin, \n      1,     2,      10,   \n      3,     4,       9\n) \n```\n:::\n\n\nFrom these data, we cannot determine how good teams 1-2 and compared to teams\n3-4. Even if with a lot more data we may not be able to estimate the model\nparameters.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd4 <- tribble(\n  ~home, ~away, ~margin, \n      1,     2,      10,   \n      3,     4,       9, \n      1,     2,       5,   \n      3,     4,      13, \n      1,     2,       1,   \n      3,     4,      -3, \n      1,     2,       2,   \n      3,     4,      -6 \n) \n```\n:::\n\n\nIf we try to actually fit this model, \n\n\n::: {.cell}\n\n```{.r .cell-code}\nX4 <- construct_model_matrix(d4)\nm4 <- lm(d4$margin ~ X4)\nsummary(m4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = d4$margin ~ X4)\n\nResiduals:\n   Min     1Q Median     3Q    Max \n-9.250 -4.188 -1.000  5.562  9.750 \n\nCoefficients: (3 not defined because of singularities)\n            Estimate Std. Error t value Pr(>|t|)\n(Intercept)    3.250      3.546   0.917    0.395\nX41            1.250      5.015   0.249    0.811\nX42               NA         NA      NA       NA\nX43               NA         NA      NA       NA\nX44               NA         NA      NA       NA\n\nResidual standard error: 7.092 on 6 degrees of freedom\nMultiple R-squared:  0.01025,\tAdjusted R-squared:  -0.1547 \nF-statistic: 0.06214 on 1 and 6 DF,  p-value: 0.8115\n```\n\n\n:::\n:::\n\n\nWhile previously we had only 1 line with NAs, \nwe now have 3 lines with NAs. \n\n::: {.callout-note}\n## Estimability\nParameters are said to be *estimable* with a certain said of data if\nthe parameters can be estimated with that data. \nThus parameters may be *identifiable* but not estimable while\nparameters that are not identifiable are never estimable. \n:::\n\n#### Graphs\n\nIn these models, the graph of team contests is helpful. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"igraph\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'igraph'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:lubridate':\n\n    %--%, union\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:dplyr':\n\n    as_data_frame, groups, union\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:purrr':\n\n    compose, simplify\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:tidyr':\n\n    crossing\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:tibble':\n\n    as_data_frame\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    decompose, spectrum\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:base':\n\n    union\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(graph_from_data_frame(d3[,c(2,1)]))          # arrows point away -> home\n```\n\n::: {.cell-output-display}\n![](06-margin-of-victory_files/figure-html/graph-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(graph_from_data_frame(d3, directed = FALSE))\n```\n\n::: {.cell-output-display}\n![](06-margin-of-victory_files/figure-html/graph-2.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(graph_from_data_frame(d4, directed = FALSE))\n```\n\n::: {.cell-output-display}\n![](06-margin-of-victory_files/figure-html/graph-3.png){width=672}\n:::\n:::\n\n\nParameters (or functions of parameters) may also be weakly estimable. \nConsider these data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_conf <- tribble(\n  ~home, ~away, ~margin, \n      1,     2,      10, # Conference 1  \n      3,     4,       9, \n      2,     3,      -2,\n      1,     4,     -20,\n      3,     1,       4,\n      4,     2,      16,\n      5,     6,      10, # Conference 2\n      7,     8,       9, \n      6,     7,      -2,\n      5,     8,     -20,\n      7,     5,       4,\n      8,     6,      16,\n      1,     5,      10 # Inter-conference Game\n) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(graph_from_data_frame(d_conf[, c(2,1)]))\n```\n\n::: {.cell-output-display}\n![](06-margin-of-victory_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nPredict the outcome for two teams \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Predict the outcome for 3 vs 7\nXconf <- construct_model_matrix(d_conf)\nm <- lm(d_conf$margin ~ Xconf)\nsummary(m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = d_conf$margin ~ Xconf)\n\nResiduals:\n         1          2          3          4          5          6          7 \n 4.850e+00  1.035e+01  3.800e+00 -1.140e+01 -6.550e+00 -1.050e+00  4.850e+00 \n         8          9         10         11         12         13 \n 1.035e+01  3.800e+00 -1.140e+01 -6.550e+00 -1.050e+00 -2.092e-15 \n\nCoefficients: (1 not defined because of singularities)\n            Estimate Std. Error t value Pr(>|t|)\n(Intercept)    3.300      3.572   0.924    0.398\nXconf1        -5.200     14.837  -0.350    0.740\nXconf2        -7.050     16.371  -0.431    0.685\nXconf3         2.050     16.851   0.122    0.908\nXconf4         6.700     16.371   0.409    0.699\nXconf5       -11.900      8.185  -1.454    0.206\nXconf6       -13.750      7.988  -1.721    0.146\nXconf7        -4.650      8.185  -0.568    0.595\nXconf8            NA         NA      NA       NA\n\nResidual standard error: 11.3 on 5 degrees of freedom\nMultiple R-squared:  0.6168,\tAdjusted R-squared:  0.08026 \nF-statistic:  1.15 on 7 and 5 DF,  p-value: 0.4547\n```\n\n\n:::\n\n```{.r .cell-code}\n# Expected point difference (neutral court)\n(exp_diff <- coef(m)[4] - coef(m)[8])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nXconf3 \n   6.7 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Probability of winning (neutral court)\npt( exp_diff / summary(m)$sigma, df = summary(m)$df[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Xconf3 \n0.7105335 \n```\n\n\n:::\n:::\n\n\nNow let's change the result for the intraconference game and see what happens.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_conf2 <- d_conf\nd_conf2$margin[nrow(d_conf2)]        # old score\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 10\n```\n\n\n:::\n\n```{.r .cell-code}\nd_conf2$margin[nrow(d_conf2)] <- -10 # new score\n\n# Predict the outcome for 3 vs 7\nXconf2 <- construct_model_matrix(d_conf2)\nm2 <- lm(d_conf2$margin ~ Xconf2)\nsummary(m2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = d_conf2$margin ~ Xconf2)\n\nResiduals:\n         1          2          3          4          5          6          7 \n 4.850e+00  1.035e+01  3.800e+00 -1.140e+01 -6.550e+00 -1.050e+00  4.850e+00 \n         8          9         10         11         12         13 \n 1.035e+01  3.800e+00 -1.140e+01 -6.550e+00 -1.050e+00 -3.795e-15 \n\nCoefficients: (1 not defined because of singularities)\n            Estimate Std. Error t value Pr(>|t|)\n(Intercept)    3.300      3.572   0.924    0.398\nXconf21      -25.200     14.837  -1.698    0.150\nXconf22      -27.050     16.371  -1.652    0.159\nXconf23      -17.950     16.851  -1.065    0.335\nXconf24      -13.300     16.371  -0.812    0.453\nXconf25      -11.900      8.185  -1.454    0.206\nXconf26      -13.750      7.988  -1.721    0.146\nXconf27       -4.650      8.185  -0.568    0.595\nXconf28           NA         NA      NA       NA\n\nResidual standard error: 11.3 on 5 degrees of freedom\nMultiple R-squared:  0.6394,\tAdjusted R-squared:  0.1346 \nF-statistic: 1.267 on 7 and 5 DF,  p-value: 0.4111\n```\n\n\n:::\n\n```{.r .cell-code}\n# Expected point difference (neutral court)\n(exp_diff2 <- coef(m2)[4] - coef(m2)[8])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nXconf23 \n  -13.3 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Probability of winning (neutral court)\npt( exp_diff2 / summary(m2)$sigma, df = summary(m2)$df[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Xconf23 \n0.1460273 \n```\n\n\n:::\n:::\n\n\nInter-conference play determines amount of ``strength'' allocated to the\nconference. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(coef(m)[-1], coef(m2)[-1])\n```\n\n::: {.cell-output-display}\n![](06-margin-of-victory_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n## Rating Systems\n\n### Sagarin Ratings\n\nAn example of publish margin of victory model estimates are\n[Sagarin Ratings](http://sagarin.com/sports/cbsend.htm).\nThere is an \n[R package that may be able to scrape Sagarin ratings](https://github.com/jarad/sagarin).\nArgh, these have stopped being updated in 2023.\n\n### Ken Pomeroy\n\nI believe \n[Ken Pomeroy's ratings](https://kenpom.com/index.php) are based on \nthese margin-of-victory models. \n\n\n\n\n## Examples\n\n### Iowa High School Football\n\n\n### International Handball\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhandball2024 <- read_csv(\"data/Handball_W_InternationalResults.csv\",\n                     col_types = cols(\n                       ScoreA = col_double(),\n                       ScoreB = col_double(),\n                       year = col_integer(),\n                       Date = col_date(),\n                       .default = col_character()\n                     )) |>\n  filter(year == 2024) |>\n  mutate(\n    margin = ScoreA - ScoreB\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot(graph_from_data_frame(handball[,c(\"TeamA\",\"TeamB\")]), directed = FALSE)\n\nlibrary(\"networkD3\")\n\np <- simpleNetwork(handball2024, \n                   height=\"100px\", width=\"100px\",        \n        Source = \"TeamA\",                 # column number of source\n        Target = \"TeamB\",                 # column number of target\n        linkDistance = 10,          # distance between node. Increase this value to have more space between nodes\n        charge = -900,                # numeric value indicating either the strength of the node repulsion (negative value) or attraction (positive value)\n        fontSize = 14,               # size of the node names\n        fontFamily = \"serif\",       # font og node names\n        linkColour = \"#666\",        # colour of edges, MUST be a common colour for the whole graph\n        nodeColour = \"#69b3a2\",     # colour of nodes, MUST be a common colour for the whole graph\n        opacity = 0.9,              # opacity of nodes. 0=transparent. 1=no transparency\n        zoom = T                    # Can you zoom on the figure?\n        )\n\np\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"forceNetwork html-widget html-fill-item\" id=\"htmlwidget-882046bb11d2bd520728\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-882046bb11d2bd520728\">{\"x\":{\"links\":{\"source\":[37,10,18,4,37,4,18,10,18,4,10,37,16,47,40,22,47,16,22,47,16,40,11,31,14,36,11,14,31,36,14,36,31,11,41,15,27,23,41,27,15,23,23,27,15,41,32,43,3,28,3,32,28,43,3,28,43,32,30,39,6,46,6,39,46,30,46,6,30,39,20,44,29,13,29,20,44,13,29,13,44,20,12,26,35,12,26,35,45,19,33,2,19,33,45,2,2,33,45,19,7,0,7,9,38,0,8,42,21,42,24,8,8,25,25,24,19,44,44,24,17,19,11,31,31,1,11,43,16,30,16,41,34,30,41,16,33,42,44,12,16,33,44,42,16,41,41,33,12,31,43,19,5,0,15,31,19,15,31,43,0,19,43,5,12,15,19,33,44,33,12,33],\"target\":[4,18,37,10,10,18,4,37,10,37,4,18,47,40,16,47,22,40,40,16,22,47,14,36,31,11,31,36,11,14,11,31,14,36,27,23,15,41,15,23,41,27,15,41,27,23,3,28,43,32,28,43,3,32,32,43,3,28,46,6,30,39,46,30,6,39,30,39,6,46,29,13,44,20,13,44,20,29,20,44,29,13,26,12,12,35,35,26,2,33,45,19,45,2,19,33,45,19,33,2,9,38,38,0,9,7,25,21,24,8,25,21,24,42,21,42,17,24,19,17,44,24,43,1,11,43,1,31,41,34,30,34,16,41,12,42,44,41,16,33,41,42,12,44,12,33,44,16,42,0,5,15,19,43,31,43,0,5,5,19,15,31,15,0,31,16,44,5,15,12,44,15],\"value\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"colour\":[\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\"]},\"nodes\":{\"name\":[\"Angola\",\"Argentina\",\"Austria\",\"Azerbaijan\",\"Bosnia and Herzegovina\",\"Brazil\",\"Bulgaria\",\"Cameroon\",\"China\",\"Congo\",\"Croatia\",\"Czech Republic\",\"Denmark\",\"Faroe Islands\",\"Finland\",\"France\",\"Germany\",\"Great Britain\",\"Greece\",\"Hungary\",\"Iceland\",\"India\",\"Israel\",\"Italy\",\"Japan\",\"Kazakhstan\",\"Kosovo\",\"Latvia\",\"Lithuania\",\"Luxembourg\",\"Montenegro\",\"Netherlands\",\"North Macedonia\",\"Norway\",\"Paraguay\",\"Poland\",\"Portugal\",\"Romania\",\"Senegal\",\"Serbia\",\"Slovakia\",\"Slovenia\",\"South Korea\",\"Spain\",\"Sweden\",\"Switzerland\",\"Turkey\",\"Ukraine\"],\"group\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"nodesize\":[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8]},\"options\":{\"NodeID\":\"name\",\"Group\":\"group\",\"colourScale\":\"d3.scaleOrdinal(['#69b3a2'])\",\"fontSize\":14,\"fontFamily\":\"serif\",\"clickTextSize\":35,\"linkDistance\":10,\"linkWidth\":\"'1.5px'.toString()\",\"charge\":-900,\"opacity\":0.9,\"zoom\":true,\"legend\":false,\"arrows\":false,\"nodesize\":true,\"radiusCalculation\":\"d.nodesize\",\"bounded\":false,\"opacityNoHover\":1,\"clickAction\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nseparated_countries <- c(\"Romania\", \"Bosnia and Herzegovina\", \"Greece\", \"Croatia\")\n\nhandball2024b <- handball2024 |>\n  filter(!( TeamA %in% separated_countries | TeamB %in% separated_countries) )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert team names into factors\nteams <- data.frame(\n  names = c(handball2024b$TeamA, handball2024b$TeamB) |>\n    unique() |>\n    sort() |>\n    factor()\n) \n\nX_h <- handball2024b |>\n  rename(\n    home = TeamA,\n    away = TeamB\n  ) |>\n  mutate(\n    home = factor(home, levels = teams$names),\n    away = factor(away, levels = teams$names)\n  ) |>\n  construct_model_matrix()\n\ndim(X_h) # n_games x n_teams\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 160  44\n```\n\n\n:::\n\n```{.r .cell-code}\nm <- lm(handball2024b$margin ~ X_h - 1) # remove the home field advantage\nsummary(m)$sigma\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5.900357\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nteams$strength <- coef(m)\nteams$strength[nrow(teams)] <- 0\nteams$strength <- teams$strength - mean(teams$strength)\n\nteams$names <- factor(teams$names, levels = teams$names[order(teams$strength)])\n\nggplot(teams, \n       aes(\n         x = strength,\n         y = names\n       )) +\n  geom_bar(stat = \"identity\")\n```\n\n::: {.cell-output-display}\n![](06-margin-of-victory_files/figure-html/handball-strength-1.png){width=672}\n:::\n:::\n\n\nThe distribution of scores around the expected score.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_histogram(\n    aes(\n      x = m$residuals,\n        y = after_stat(density)\n    ), # Get frequency rather than count\n    binwidth = 1,\n  ) +\n  stat_function(\n    fun  = dnorm, \n    args = list(\n      mean = mean(m$residuals),\n      sd   = sd(m$residuals)\n    ), \n    color = \"red\"\n  ) +\n  labs(\n    x = 'Actual Score - Expected Score',\n    y = 'Density',\n    title = 'Handball Score Variability'\n  )\n```\n\n::: {.cell-output-display}\n![](06-margin-of-victory_files/figure-html/handball-residuals-1.png){width=672}\n:::\n:::\n\n\nI was expecting these residuals to be centered at 0,\nbut I fit a model that did not include an intercept\n(since there was no clear home field). \nPerhaps an intercept was needed?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Refit model with intercept\nm <- lm(handball2024b$margin ~ X_h) \nsummary(m)$coefficients[1,]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Estimate  Std. Error     t value    Pr(>|t|) \n1.281715708 0.466134486 2.749669350 0.006921771 \n```\n\n\n:::\n:::\n\n\nIt appears the intercept is significant. \nTaking a look at the data, there appears to be a Venue listed and this Venue\nwould provide information about a possible home-field advantage.\nThe analysis here would likely need to be a bit more complex as the home-field\nadvantage should only be listed when a team is actually playing at home. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nhandball2024b |> \n  select(TeamA, TeamB, Venue) |> \n  as.data.frame()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n              TeamA           TeamB           Venue\n1           Germany         Ukraine         Germany\n2           Ukraine        Slovakia          Poland\n3          Slovakia         Germany        Slovakia\n4            Israel         Ukraine        Slovakia\n5           Ukraine          Israel        Slovakia\n6           Germany        Slovakia         Germany\n7            Israel        Slovakia         Germany\n8           Ukraine         Germany         Germany\n9           Germany          Israel         Germany\n10         Slovakia         Ukraine        Slovakia\n11   Czech Republic         Finland  Czech Republic\n12      Netherlands        Portugal     Netherlands\n13          Finland     Netherlands         Finland\n14         Portugal  Czech Republic        Portugal\n15   Czech Republic     Netherlands  Czech Republic\n16          Finland        Portugal         Finland\n17      Netherlands  Czech Republic     Netherlands\n18         Portugal         Finland        Portugal\n19          Finland  Czech Republic         Finland\n20         Portugal     Netherlands        Portugal\n21      Netherlands         Finland     Netherlands\n22   Czech Republic        Portugal  Czech Republic\n23         Slovenia          Latvia        Slovenia\n24           France           Italy          France\n25           Latvia          France          Latvia\n26            Italy        Slovenia           Italy\n27         Slovenia          France        Slovenia\n28           Latvia           Italy          Latvia\n29           France        Slovenia          France\n30            Italy          Latvia           Italy\n31            Italy          France           Italy\n32           Latvia        Slovenia          Latvia\n33           France          Latvia          France\n34         Slovenia           Italy        Slovenia\n35  North Macedonia      Azerbaijan North Macedonia\n36            Spain       Lithuania           Spain\n37       Azerbaijan           Spain      Azerbaijan\n38        Lithuania North Macedonia       Lithuania\n39       Azerbaijan       Lithuania      Azerbaijan\n40  North Macedonia           Spain North Macedonia\n41        Lithuania      Azerbaijan       Lithuania\n42            Spain North Macedonia           Spain\n43       Azerbaijan North Macedonia      Azerbaijan\n44        Lithuania           Spain       Lithuania\n45            Spain      Azerbaijan           Spain\n46  North Macedonia       Lithuania North Macedonia\n47       Montenegro          Turkey      Montenegro\n48           Serbia        Bulgaria          Serbia\n49         Bulgaria      Montenegro        Bulgaria\n50           Turkey          Serbia          Turkey\n51         Bulgaria          Turkey        Bulgaria\n52           Serbia      Montenegro          Serbia\n53           Turkey        Bulgaria          Turkey\n54       Montenegro          Serbia      Montenegro\n55           Turkey      Montenegro          Turkey\n56         Bulgaria          Serbia        Bulgaria\n57       Montenegro        Bulgaria      Montenegro\n58           Serbia          Turkey          Serbia\n59          Iceland      Luxembourg         Iceland\n60           Sweden   Faroe Islands          Sweden\n61       Luxembourg          Sweden      Luxembourg\n62    Faroe Islands         Iceland   Faroe Islands\n63       Luxembourg   Faroe Islands      Luxembourg\n64          Iceland          Sweden         Iceland\n65           Sweden         Iceland          Sweden\n66    Faroe Islands      Luxembourg   Faroe Islands\n67       Luxembourg         Iceland      Luxembourg\n68    Faroe Islands          Sweden   Faroe Islands\n69           Sweden      Luxembourg          Sweden\n70          Iceland   Faroe Islands         Iceland\n71          Denmark          Kosovo         Denmark\n72           Kosovo         Denmark          Kosovo\n73           Poland         Denmark          Poland\n74          Denmark          Poland         Denmark\n75           Kosovo          Poland          Kosovo\n76           Poland          Kosovo          Poland\n77      Switzerland         Austria     Switzerland\n78          Hungary          Norway         Hungary\n79           Norway     Switzerland          Norway\n80          Austria         Hungary         Austria\n81          Hungary     Switzerland         Hungary\n82           Norway         Austria          Norway\n83      Switzerland         Hungary     Switzerland\n84          Austria          Norway         Austria\n85          Austria     Switzerland         Austria\n86           Norway         Hungary          Norway\n87      Switzerland          Norway     Switzerland\n88          Hungary         Austria         Hungary\n89         Cameroon           Congo          Angola\n90           Angola         Senegal          Angola\n91         Cameroon         Senegal          Angola\n92            Congo          Angola          Angola\n93          Senegal           Congo          Angola\n94           Angola        Cameroon          Angola\n95            China      Kazakhstan           Japan\n96      South Korea           India           Japan\n97            India           Japan           Japan\n98      South Korea           China           Japan\n99            Japan      Kazakhstan           Japan\n100           China           India           Japan\n101           China           Japan           Japan\n102      Kazakhstan     South Korea           Japan\n103      Kazakhstan           India           Japan\n104           Japan     South Korea           Japan\n105         Hungary   Great Britain         Hungary\n106          Sweden           Japan         Hungary\n107          Sweden         Hungary         Hungary\n108           Japan   Great Britain         Hungary\n109   Great Britain          Sweden         Hungary\n110         Hungary           Japan         Hungary\n111  Czech Republic           Spain           Spain\n112     Netherlands       Argentina           Spain\n113     Netherlands  Czech Republic           Spain\n114       Argentina           Spain           Spain\n115  Czech Republic       Argentina           Spain\n116           Spain     Netherlands           Spain\n117         Germany        Slovenia         Germany\n118      Montenegro        Paraguay         Germany\n119         Germany      Montenegro         Germany\n120        Slovenia        Paraguay         Germany\n121        Paraguay         Germany         Germany\n122      Montenegro        Slovenia         Germany\n123        Slovenia         Denmark          France\n124         Germany     South Korea          France\n125          Norway          Sweden          France\n126     South Korea        Slovenia          France\n127          Sweden         Germany          France\n128         Denmark          Norway          France\n129         Germany        Slovenia          France\n130          Norway     South Korea          France\n131          Sweden         Denmark          France\n132     South Korea          Sweden          France\n133         Germany         Denmark          France\n134        Slovenia          Norway          France\n135        Slovenia          Sweden          France\n136          Norway         Germany          France\n137         Denmark     South Korea          France\n138     Netherlands          Angola          France\n139           Spain          Brazil          France\n140         Hungary          France          France\n141          Brazil         Hungary          France\n142          Angola           Spain          France\n143          France     Netherlands          France\n144     Netherlands           Spain          France\n145         Hungary          Angola          France\n146          France          Brazil          France\n147     Netherlands          Brazil          France\n148           Spain         Hungary          France\n149          Angola          France          France\n150         Hungary     Netherlands          France\n151           Spain          France          France\n152          Brazil          Angola          France\n153         Denmark     Netherlands          France\n154          France         Germany          France\n155         Hungary          Sweden          France\n156          Norway          Brazil          France\n157          Sweden          France          France\n158          Norway         Denmark          France\n159         Denmark          Sweden          France\n160          Norway          France          France\n```\n\n\n:::\n:::\n\n\n### College Baseball 2024\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbaseball <- read.csv(\"data/college_baseball_2024.csv\")\n```\n:::\n\n\nLet's take a look at these data. \n(Really I got quite a way in the analysis and realized an issue, \nso now I'm back fixing up the data.)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstr(baseball)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t123 obs. of  6 variables:\n $ Dates     : chr  \"3/17/2023\" \"3/17/2023\" \"3/17/2023\" \"3/18/2023\" ...\n $ Team_1    : chr  \"Kansas State\" \"Texas Christian\" \"Texas Tech\" \"Baylor\" ...\n $ Score_1   : int  8 13 8 8 9 3 8 7 12 7 ...\n $ Team_2    : chr  \"Baylor\" \"Oklahoma\" \"Oklahoma State\" \"Kansas State\" ...\n $ Score_2   : int  1 5 7 4 4 1 4 5 1 1 ...\n $ Home_Field: chr  \"@Baylor\" \"@Oklahoma\" \"@Texas Tech\" \"@Baylor\" ...\n```\n\n\n:::\n\n```{.r .cell-code}\nsort(unique(c(baseball$Team_1, baseball$Team_2)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Baylor\"          \"Kansas\"          \"Kansas State\"    \"Oklahoma\"       \n[5] \"Oklahoma State\"  \"Texas\"           \"Texas Christian\" \"Texas Tech\"     \n[9] \"West Virginia\"  \n```\n\n\n:::\n\n```{.r .cell-code}\nsort(unique(baseball$Home_Field)) # there are neutral sites\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"@Baylor\"          \"@Kansas\"          \"@Kansas State\"    \"@neutral\"        \n [5] \"@Oklahoma\"        \"@Oklahoma State\"  \"@Texas\"           \"@Texas Christian\"\n [9] \"@Texas Tech\"      \"@West Virginia\"  \n```\n\n\n:::\n\n```{.r .cell-code}\n# Compared to sports we have been looking at baseball scores are relatively low\n# with most scores 10 or below\ntable(c(baseball$Score_1, baseball$Score_2))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 \n 4 17 18 26 21 26 28 21 19 14 15  5  8  5  4  4  2  2  3  2  1  1 \n```\n\n\n:::\n:::\n\n\nLet's deal explicitly with neutral sites. \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbaseball2024 <- baseball |>\n  \n  # Create home/away teams and scores\n  # for neutral sites, home/away will be arbitrary\n  mutate(\n    Home_Field = gsub(\"@\", \"\", Home_Field),\n    home_is_Team_1 =                        # this is used repeatedly below\n      Home_Field == \"neutral\" | \n        Home_Field == Team_1,  \n    \n    # Set the teams\n    home = ifelse(home_is_Team_1, Team_1, Team_2),\n    away = ifelse(home_is_Team_1, Team_2, Team_1),\n    \n    # Set the scores\n    home_score = ifelse(home_is_Team_1, Score_1, Score_2),\n    away_score = ifelse(home_is_Team_1, Score_2, Score_1),\n    \n    margin = home_score - away_score,\n    \n    Date = as.Date(Dates, format = \"%m/%d/%Y\")\n  ) |>\n  select(Date, Home_Field, home, away, home_score, away_score, margin)\n```\n:::\n\n\nLet's first check the graph connectedness. \n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- simpleNetwork(baseball2024, \n                   height=\"100px\", width=\"100px\",        \n        Source = \"away\",                 # column number of source\n        Target = \"home\",                 # column number of target\n        linkDistance = 10,          # distance between node. Increase this value to have more space between nodes\n        charge = -900,                # numeric value indicating either the strength of the node repulsion (negative value) or attraction (positive value)\n        fontSize = 14,               # size of the node names\n        fontFamily = \"serif\",       # font og node names\n        linkColour = \"#666\",        # colour of edges, MUST be a common colour for the whole graph\n        nodeColour = \"#69b3a2\",     # colour of nodes, MUST be a common colour for the whole graph\n        opacity = 0.9,              # opacity of nodes. 0=transparent. 1=no transparency\n        zoom = T                    # Can you zoom on the figure?\n        )\n\np\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"forceNetwork html-widget html-fill-item\" id=\"htmlwidget-54b4e64d362a4731f6f7\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-54b4e64d362a4731f6f7\">{\"x\":{\"links\":{\"source\":[2,6,4,2,4,6,2,6,4,3,0,1,7,3,0,1,7,3,0,1,7,0,6,5,8,8,0,5,6,0,5,6,8,3,4,1,3,4,2,3,2,1,4,2,1,2,7,5,8,5,2,7,8,2,8,7,5,3,4,3,0,6,0,4,3,3,0,6,4,6,7,1,8,1,7,5,8,7,1,5,8,5,5,3,3,5,5,3,2,0,7,2,0,7,2,0,7,6,1,4,8,4,6,1,8,4,6,1,8,5,4,2,8,5,8,1,3,1,3,7,7,2,4],\"target\":[0,3,7,0,7,3,0,3,7,2,4,6,5,2,4,6,5,2,4,6,5,1,7,4,2,2,1,4,7,1,4,7,2,0,6,8,0,6,5,0,5,8,6,5,8,1,3,0,4,0,1,3,4,1,4,3,0,4,1,5,7,8,7,1,5,5,7,8,1,8,2,3,0,3,2,6,0,2,3,6,0,6,1,8,8,1,1,8,4,6,8,4,6,8,4,6,8,2,7,3,5,3,2,7,5,3,2,7,5,1,3,6,7,2,4,6,7,2,4,4,4,6,6],\"value\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"colour\":[\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\",\"#666\"]},\"nodes\":{\"name\":[\"Baylor\",\"Kansas\",\"Kansas State\",\"Oklahoma\",\"Oklahoma State\",\"Texas\",\"Texas Christian\",\"Texas Tech\",\"West Virginia\"],\"group\":[1,1,1,1,1,1,1,1,1],\"nodesize\":[8,8,8,8,8,8,8,8,8]},\"options\":{\"NodeID\":\"name\",\"Group\":\"group\",\"colourScale\":\"d3.scaleOrdinal(['#69b3a2'])\",\"fontSize\":14,\"fontFamily\":\"serif\",\"clickTextSize\":35,\"linkDistance\":10,\"linkWidth\":\"'1.5px'.toString()\",\"charge\":-900,\"opacity\":0.9,\"zoom\":true,\"legend\":false,\"arrows\":false,\"nodesize\":true,\"radiusCalculation\":\"d.nodesize\",\"bounded\":false,\"opacityNoHover\":1,\"clickAction\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n\nLet's build our model for margin of victory depending on team strength and\ninclude home-field advantage when it is relevant. \n\n\nTo do so, we will create an additional column in the X matrix that includes a\nhome-field advantage only when playing on a home-field,\ni.e. not at a *neutral* site.\nThen, when we run the regression, we will not include an intercept. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Construct factors for teams\nteams <- data.frame(\n  names = c(baseball2024$home, baseball2024$away) |>\n    unique() |>\n    sort() |>\n    factor()\n)\n\nbaseball2024 <- baseball2024 |>\n  mutate(\n    home = factor(home, levels = teams$names),\n    away = factor(away, levels = teams$names)\n  )\n\nX_baseball <- \n  cbind(\n    1 * !(baseball2024$Home_Field == \"neutral\"),\n    construct_model_matrix(baseball2024)\n  )\n\ncolnames(X_baseball) <- c(\"home-field advantage\", as.character(teams$names))\n\nrowSums(X_baseball) # home_field advantage has a 1 and neutral is 0\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1\n [38] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1\n [75] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0\n[112] 0 0 0 0 0 0 0 0 0 0 0 0\n```\n\n\n:::\n\n```{.r .cell-code}\ncolSums(X_baseball) # difference in number of home - away games\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nhome-field advantage               Baylor               Kansas \n                 109                    0                   -1 \n        Kansas State             Oklahoma       Oklahoma State \n                   0                   -2                    3 \n               Texas      Texas Christian           Texas Tech \n                  -2                    4                    0 \n       West Virginia \n                  -2 \n```\n\n\n:::\n\n```{.r .cell-code}\nhead(X_baseball)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     home-field advantage Baylor Kansas Kansas State Oklahoma Oklahoma State\n[1,]                    1      1      0           -1        0              0\n[2,]                    1      0      0            0        1              0\n[3,]                    1      0      0            0        0             -1\n[4,]                    1      1      0           -1        0              0\n[5,]                    1      0      0            0        0             -1\n[6,]                    1      0      0            0        1              0\n     Texas Texas Christian Texas Tech West Virginia\n[1,]     0               0          0             0\n[2,]     0              -1          0             0\n[3,]     0               0          1             0\n[4,]     0               0          0             0\n[5,]     0               0          1             0\n[6,]     0              -1          0             0\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nm <- lm(baseball2024$margin ~ X_baseball - 1) # remove intercept\nsummary(m)$sigma\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5.403159\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Home field advantage\ncoef(m)[1]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nX_baseballhome-field advantage \n                      1.399588 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Team strengths\nstrength <- coef(m)[-1]\nstrength[length(strength)] <- 0\n\nteams <- teams |>\n  mutate(\n    strength = strength - mean(strength),\n    names    = factor(names, \n                      levels = names[order(strength)])\n  ) |>\n  arrange(desc(strength))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(teams,\n       aes(\n         x = strength,\n         y = names \n       )) +\n  geom_point() +\n  labs(\n    x = \"Strength\",\n    y = \"Team\",\n    title = \"2024 Big 12 College Baseball\"\n  )\n```\n\n::: {.cell-output-display}\n![](06-margin-of-victory_files/figure-html/baseball-strength-plot-1.png){width=672}\n:::\n:::\n\n\nOne aspect of these data that have not been addressed is the bias due to the\nway the 9th inning works in baseball. \nIn the bottom of the 9th inning, the home team immediately wins if they are \never ahead of the away team. \nThis could happen sometime during the 9th inning or even before the bottom of \nthe 9th inning occurs. \nThe bias that results is likely a underestimate of the home field advantage\nbecause the home team scores less points than they could have. \n\n## R packages\n\nAre there any or do we really have to do all of this by hand?\n\n",
    "supporting": [
      "06-margin-of-victory_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"site_libs/d3-4.5.0/d3.min.js\"></script>\n<script src=\"site_libs/forceNetwork-binding-0.4/forceNetwork.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}