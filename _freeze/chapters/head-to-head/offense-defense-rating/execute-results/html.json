{
  "hash": "b5db0290623b15be8674a3e163407120",
  "result": {
    "engine": "knitr",
    "markdown": "# Offense-Defense Rating\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"tidyverse\"); theme_set(theme_bw())\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'purrr' was built under R version 4.4.1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4.9000     ✔ readr     2.1.5     \n✔ forcats   1.0.0          ✔ stringr   1.5.1     \n✔ ggplot2   3.5.1          ✔ tibble    3.2.1     \n✔ lubridate 1.9.3          ✔ tidyr     1.3.1     \n✔ purrr     1.0.4          \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(\"DT\")\n```\n:::\n\n\nA simple example of offense-defense data is this fictitious collection of 4 \nteams that have played 5 games. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- tribble(\n  ~home, ~away, ~home_score, ~away_score, \n      1,     2,          21,           7,\n      2,     3,          13,          14,\n      4,     1,           3,          28,\n      3,     4,          31,           0,\n      1,     3,          42,          10\n) \n```\n:::\n\n\nPreviously, we calculated the margin of victory (home score minus away score)\nand constructed a model for the margin of victory. \nIn those models, we estimated a team strength and used the difference in team\nstrengths to calculate the expected margin of victory and game outcome\nprobabilities. \n\nIn this chapter, we will build models for the both the home score and the \naway score. \nUsing the scores allows us to estimate offense and defense team strengths. \n\n\n\n## Model\n\nA model for the number of points scored by the home team is \n\n$$S^H_g = \\eta + \\theta_{H[g]} - \\delta_{A[g]} + \\epsilon^H_g$$\n\nwhere, for game $g$,\n\n- $S^H_g$ is the score for the home team,\n- $H[g]$ is the ID for the home team, \n- $A[g]$ is the ID for the away team,\n- $\\epsilon^H_g$ is a random error.\n\nThis error arises because if two teams play each other repeatedly we would \nexpect the home score would be random around the expected\nhome score.\n\nThe parameters are \n\n- $\\eta$ is the offensive home advantage, \n- $\\theta_t$ is the offensive strength of team $t$, and\n- $\\delta_t$ is the defense strength of team $t$.\n\nThe expected home score when team $H$ is at home playing against team $A$ is \n\n$$E\\left[S^H\\right] = \\eta + \\theta_{H} - \\delta_{A}.$$\nWe can build a similar model for the away team score. \nA model for the number of points scored by the away team is \n\n$$S^A_g = \\theta_{A[g]} - \\delta_{H[g]} + \\epsilon^A_g$$\n\nwhere, for game $g$,\n\n- $S^A_g$ is the score for the away team,\n- $\\epsilon^A_g$ is a random error.\n\nThis error arises because if two teams play each other repeatedly we would \nexpect the away score would be random around the expected\naway score.\n\nThe expected away score when team $H$ is at home playing against team $A$ is \n\n$$E\\left[S^A\\right] = \\theta_{A} - \\delta_{H}.$$\n\nWe can utilize these models to calculate the expected margin of victory $M$ for \nhome team $H$ playing away team $A$:\n$$\\begin{array}{rl} \nE[M] \n&= E[S^H - S^A] \\\\\n&= E[S^H] - E[S^A] \\\\\n&= \\eta + \\theta_H  - \\delta_A - (\\eta_D + \\theta_A - \\delta_H) \\\\\n&= \\eta + (\\theta_H + \\delta_H) - (\\theta_A + \\delta_A) \n\\end{array}\n$$\nwhere \n\n- $\\eta$ is the home advantage,\n- $\\theta_H - \\delta_H$ is the strength of the home team, and\n- $\\theta_A - \\delta_A$ is the strength of the away team.\n\n\n\n### Identifiability\n\nIn this model, \nwhen two teams play each other, the score is expected to be the \nhome advantage $\\eta$ plus the difference in strengths between the two\nteams $\\theta - \\delta$.\nThus, only the difference between the offense and defense rating is identifiable.\nand we can arbitrarily add a constant to all of the $\\theta$ and $\\delta$ values. \n\n\n\n### Regression\n\n\nIf we assume $\\epsilon_g^H, \\epsilon_g^A  \\stackrel{ind}{\\sim} N(0,\\sigma^2)$,\nthen this is a linear regression model. \n\nSince we have both the offensive parameters ($\\theta$s) and defensive \nparameters ($\\delta$s), \nwe will need to construct a home matrix $X^H$ and an away matrix $X^A$. \n\nFor $X^H$ we have \n$$X^H_{g,t} = \\left\\{\n\\begin{array}{rl}\n1 & \\mbox{if team $t$ is the {\\bf home} team in game $g$} \\\\\n0 & \\mbox{otherwise}\n\\end{array} \\right.$$\n\nFor $X^A$ we have \n$$X^A_{g,t} = \\left\\{\n\\begin{array}{rl}\n1 & \\mbox{if team $t$ is the {\\bf away} team in game $g$} \\\\\n0 & \\mbox{otherwise}\n\\end{array} \\right.$$\n\nCompared to the model matrices we created earlier, \nwe have no negative values (-1) in these matrices. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nconstruct_matrix <- function(d, Col = \"home\") {\n  n_games <- nrow(d)\n  n_teams <- length(unique(unlist(d[, Col])))\n  \n  m <- matrix(0, \n              nrow = n_games, \n              ncol = n_teams)\n  \n  for (g in 1:n_games) {\n    m[g, as.numeric(d[g, Col])] <-  1\n  }\n  \n  return(m)\n}\n\nX_h <- construct_matrix(d, \"home\")\nX_a <- construct_matrix(d, \"away\")\n```\n:::\n\n\nCheck to make sure these matrices are appropriate\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# n_games x n_teams\ndim(X_h) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5 4\n```\n\n\n:::\n\n```{.r .cell-code}\ndim(X_a) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5 4\n```\n\n\n:::\n\n```{.r .cell-code}\n# all entries are 0 or 1\nall(unique(X_h) %in% 0:1) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nall(unique(X_a) %in% 0:1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nall(rowSums(X_h) == 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nall(rowSums(X_a) == 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n:::\n\n\n\n\nTo see how this is a linear regression model, \nwe can construct a regression model using matrix algebra\n$$\nY = \\left[ \\begin{array}{c} \nS^H_1 \\\\ \\vdots \\\\ S^H_G \\\\\nS^A_1 \\\\ \\vdots \\\\ S^A_G \n\\end{array} \\right] \n= \\left[ \\begin{array}{cc} \n1 & X_h & -X_a \\\\ 0 & X_a & -X_h\n\\end{array} \\right] \n\\left[ \\begin{array}{c} \n\\eta \\\\ \n\\theta_1 \\\\ \\vdots \\\\ \\theta_T \\\\\n\\delta_1 \\\\ \\vdots \\\\ \\delta_T \n\\end{array} \\right] + \n\\left[ \\begin{array}{c}\n\\epsilon_1^H \\\\ \\vdots \\\\ \\epsilon_G^H \\\\\n\\epsilon_1^A \\\\ \\vdots \\\\ \\epsilon_G^A \n\\end{array} \\right]\n= X\\beta + \\epsilon\n$$\nwhere \n\n- $G$ is the number of games,\n- $T$ is the number of teams, and\n- $1$ ($0$) is shorthand for a $G \\times 1$ vector of all 1s (0s), and\n- $\\epsilon$ is a $G\\times 2$ vector with $\\epsilon \\sim N(0,\\sigma^2 \\mathrm{I})$.\n\n\n\n\n\n\n\nThus, we can estimate the parameters in this model using linear regression.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Construct score vector\nY <- c(d$home_score, d$away_score)\n\n# Construct (complete) model matrix\nX <- rbind(\n  cbind(1, X_h, -X_a),\n  cbind(0, X_a, -X_h)\n)\n\n# Fit model\nm <- lm(Y ~ 0 + X) # 0 removes intercept (so does -1) \nsummary(m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = Y ~ 0 + X)\n\nResiduals:\n     1      2      3      4      5      6      7      8      9     10 \n-3.833 -4.083  1.194  1.444  5.278  4.083  3.833 -1.444 -1.194 -5.278 \n\nCoefficients: (1 not defined because of singularities)\n   Estimate Std. Error t value Pr(>|t|)  \nX1   7.3889     5.2804   1.399   0.2967  \nX2  29.4444     7.3500   4.006   0.0570 .\nX3   9.8056    10.0536   0.975   0.4323  \nX4  22.1667     6.8595   3.232   0.0839 .\nX5   1.3056    10.0536   0.130   0.9086  \nX6   6.8889     8.6565   0.796   0.5096  \nX7  12.0000     7.9206   1.515   0.2690  \nX8   0.1111     8.6565   0.013   0.9909  \nX9       NA         NA      NA       NA  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 7.921 on 2 degrees of freedom\nMultiple R-squared:  0.9719,\tAdjusted R-squared:  0.8597 \nF-statistic: 8.662 on 8 and 2 DF,  p-value: 0.1076\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhome_advantage <- coef(m)[1]\n\nteams <- data.frame(\n  team = rep(1:4, times = 2),\n  type = rep(c(\"offense\", \"defense\"), each = 4),\n  rating = coef(m)[-1]\n) |>\n  mutate(\n    rating = ifelse(is.na(rating), 0, rating),\n    rating = rating - mean(rating)\n  ) |>\n  pivot_wider(\n    names_from = type,\n    values_from = rating\n  ) |>\n  mutate(\n    strength = offense + defense\n  )\n\nteams |> \n  datatable(filter = \"top\") |>\n  formatRound(columns = c('offense', 'defense', 'strength'), \n              digits = 2)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-a7a7dcdfecabb6834aa1\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-a7a7dcdfecabb6834aa1\">{\"x\":{\"filter\":\"top\",\"vertical\":false,\"filterHTML\":\"<tr>\\n  <td><\\/td>\\n  <td data-type=\\\"integer\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"1\\\" data-max=\\\"4\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"number\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"-8.90972222222222\\\" data-max=\\\"19.2291666666667\\\" data-scale=\\\"15\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"number\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"-10.2152777777778\\\" data-max=\\\"1.78472222222222\\\" data-scale=\\\"15\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"number\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"-19.125\\\" data-max=\\\"15.9027777777778\\\" data-scale=\\\"15\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n<\\/tr>\",\"data\":[[\"1\",\"2\",\"3\",\"4\"],[1,2,3,4],[19.22916666666666,-0.4097222222222161,11.95138888888889,-8.909722222222223],[-3.326388888888888,1.784722222222216,-10.10416666666667,-10.21527777777778],[15.90277777777778,1.375,1.847222222222218,-19.125]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>team<\\/th>\\n      <th>offense<\\/th>\\n      <th>defense<\\/th>\\n      <th>strength<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"targets\":2,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":3,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":4,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"className\":\"dt-right\",\"targets\":[1,2,3,4]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"team\",\"targets\":1},{\"name\":\"offense\",\"targets\":2},{\"name\":\"defense\",\"targets\":3},{\"name\":\"strength\",\"targets\":4}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false,\"orderCellsTop\":true}},\"evals\":[\"options.columnDefs.0.render\",\"options.columnDefs.1.render\",\"options.columnDefs.2.render\"],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n### Prediction\n\nLet $S^H$ ($S^A$) be the score for the home (away) team in an upcoming game. \nThe regression model assumes\n$$\nS^H \\sim N(\\eta + \\theta_H - \\delta_A, \\sigma^2) \n\\quad \\mbox{and (independently)} \\quad \nS^A \\sim N(\\theta_A - \\delta_H, \\sigma^2). \n$$\nThus, the margin of victory $M$ is \n$$\nM = S^H - S^A \\sim N(E[M], 2\\sigma^2)\n$$\nwhere \n$$E[M] = \\eta + (\\theta_H + \\delta_H) - (\\theta_A + \\delta_A).$$\n\n\n\nTo find the probability the home team wins we use \n$$P(M > 0) \n= P\\left( T_v > \\frac{-E[M]}{\\sigma\\sqrt{2}} \\right) \n= P\\left( T_v < \\frac{ E[M]}{\\sigma\\sqrt{2}} \\right)\n$$\nwhere $T_v$ is a T-distribution with $v$ is the degrees of freedom.\nThe degrees of freedom can be calculated using $v = 2(G-T)$.\n\nIf $G >> T$ (which is certainly not true in our simple example), \nthen $T_v \\stackrel{d}{\\approx} Z$ \n(where $\\stackrel{d}{\\approx}$ means approximately equal in distribution).\nThus, we can calculate the probability using\n$$\nP(M > 0) \\approx P\\left( Z < \\frac{ E[M]}{\\sigma\\sqrt{2}} \\right).\n$$\n\nThe standard deviation here is \n\n\n::: {.cell}\n\n```{.r .cell-code}\n(sd <- summary(m)$sigma)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 7.920613\n```\n\n\n:::\n:::\n\n\n\nSuppose Team 1 plays against Team 2 at Team 1's home. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Margin of Victory: Team 1 (Home) - Team 2 (Away)\nexpected_margin <- as.numeric(coef(m)[1] + \n                                teams[1, \"strength\"] - \n                                teams[2, \"strength\"]) \n\n# Probability of Victory: Team 1 (Home) - Team 2 (Away)\npt(expected_margin / (sd * sqrt(2)), df = summary(m)$df[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.9052297\n```\n\n\n:::\n:::\n\n\n\n## Examples\n\n### 2023 Intraconference Big12 Baseball \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Big 12 2023 Intraconference games\n# I'm not sure why the file uses 2024\nbaseball <- read.csv(\"../../data/college_baseball_2024.csv\") |>\n  \n  # Create home/away teams and scores\n  # for neutral sites, home/away will be arbitrary\n  mutate(\n    Home_Field = gsub(\"@\", \"\", Home_Field),\n    home_is_Team_1 =                        # this is used repeatedly below\n      Home_Field == \"neutral\" | \n        Home_Field == Team_1,  \n    \n    # Set the teams\n    home = ifelse(home_is_Team_1, Team_1, Team_2),\n    away = ifelse(home_is_Team_1, Team_2, Team_1),\n    \n    # Set the scores\n    home_score = ifelse(home_is_Team_1, Score_1, Score_2),\n    away_score = ifelse(home_is_Team_1, Score_2, Score_1),\n    \n    Date = as.Date(Dates, format = \"%m/%d/%Y\")\n  ) |>\n  filter(Home_Field != \"neutral\") |>\n  select(Date, Home_Field, home, away, home_score, away_score)\n```\n:::\n\n\n#### Exploratory\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbaseball  |>\n  datatable(filter = \"top\", rownames = FALSE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-d2760036e106e309f034\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-d2760036e106e309f034\">{\"x\":{\"filter\":\"top\",\"vertical\":false,\"filterHTML\":\"<tr>\\n  <td data-type=\\\"date\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"1679011200000\\\" data-max=\\\"1684540800000\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"character\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"character\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"character\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"integer\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"0\\\" data-max=\\\"20\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"integer\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"0\\\" data-max=\\\"21\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n<\\/tr>\",\"data\":[[\"2023-03-17\",\"2023-03-17\",\"2023-03-17\",\"2023-03-18\",\"2023-03-18\",\"2023-03-18\",\"2023-03-19\",\"2023-03-19\",\"2023-03-19\",\"2023-03-24\",\"2023-03-24\",\"2023-03-24\",\"2023-03-24\",\"2023-03-25\",\"2023-03-25\",\"2023-03-25\",\"2023-03-25\",\"2023-03-26\",\"2023-03-26\",\"2023-03-26\",\"2023-03-26\",\"2023-03-31\",\"2023-03-31\",\"2023-03-31\",\"2023-03-31\",\"2023-04-01\",\"2023-04-01\",\"2023-04-01\",\"2023-04-01\",\"2023-04-02\",\"2023-04-02\",\"2023-04-02\",\"2023-04-02\",\"2023-04-06\",\"2023-04-06\",\"2023-04-07\",\"2023-04-07\",\"2023-04-07\",\"2023-04-07\",\"2023-04-08\",\"2023-04-08\",\"2023-04-08\",\"2023-04-08\",\"2023-04-09\",\"2023-04-09\",\"2023-04-14\",\"2023-04-14\",\"2023-04-14\",\"2023-04-14\",\"2023-04-15\",\"2023-04-15\",\"2023-04-15\",\"2023-04-15\",\"2023-04-16\",\"2023-04-16\",\"2023-04-16\",\"2023-04-16\",\"2023-04-18\",\"2023-04-21\",\"2023-04-21\",\"2023-04-21\",\"2023-04-21\",\"2023-04-22\",\"2023-04-22\",\"2023-04-22\",\"2023-04-22\",\"2023-04-22\",\"2023-04-22\",\"2023-04-23\",\"2023-04-23\",\"2023-04-28\",\"2023-04-28\",\"2023-04-28\",\"2023-04-29\",\"2023-04-29\",\"2023-04-29\",\"2023-04-29\",\"2023-04-30\",\"2023-04-30\",\"2023-04-30\",\"2023-04-30\",\"2023-05-01\",\"2023-05-05\",\"2023-05-05\",\"2023-05-06\",\"2023-05-06\",\"2023-05-07\",\"2023-05-07\",\"2023-05-12\",\"2023-05-12\",\"2023-05-12\",\"2023-05-13\",\"2023-05-13\",\"2023-05-13\",\"2023-05-14\",\"2023-05-14\",\"2023-05-14\",\"2023-05-18\",\"2023-05-18\",\"2023-05-18\",\"2023-05-18\",\"2023-05-19\",\"2023-05-19\",\"2023-05-19\",\"2023-05-19\",\"2023-05-20\",\"2023-05-20\",\"2023-05-20\",\"2023-05-20\"],[\"Baylor\",\"Oklahoma\",\"Texas Tech\",\"Baylor\",\"Texas Tech\",\"Oklahoma\",\"Baylor\",\"Oklahoma\",\"Texas Tech\",\"Kansas State\",\"Oklahoma State\",\"Texas Christian\",\"Texas\",\"Kansas State\",\"Oklahoma State\",\"Texas Christian\",\"Texas\",\"Kansas State\",\"Oklahoma State\",\"Texas Christian\",\"Texas\",\"Kansas\",\"Texas Tech\",\"Oklahoma State\",\"Kansas State\",\"Kansas State\",\"Kansas\",\"Oklahoma State\",\"Texas Tech\",\"Kansas\",\"Oklahoma State\",\"Texas Tech\",\"Kansas State\",\"Baylor\",\"Texas Christian\",\"West Virginia\",\"Baylor\",\"Texas Christian\",\"Texas\",\"Baylor\",\"Texas\",\"West Virginia\",\"Texas Christian\",\"Texas\",\"West Virginia\",\"Kansas\",\"Oklahoma\",\"Baylor\",\"Oklahoma State\",\"Baylor\",\"Kansas\",\"Oklahoma\",\"Oklahoma State\",\"Kansas\",\"Oklahoma State\",\"Oklahoma\",\"Baylor\",\"Oklahoma State\",\"Kansas\",\"Texas\",\"Texas Tech\",\"West Virginia\",\"Texas Tech\",\"Kansas\",\"Texas\",\"Texas\",\"Texas Tech\",\"West Virginia\",\"Kansas\",\"West Virginia\",\"Kansas State\",\"Oklahoma\",\"Baylor\",\"Oklahoma\",\"Kansas State\",\"Texas Christian\",\"Baylor\",\"Kansas State\",\"Oklahoma\",\"Texas Christian\",\"Baylor\",\"Texas Christian\",\"Kansas\",\"West Virginia\",\"West Virginia\",\"Kansas\",\"Kansas\",\"West Virginia\",\"Oklahoma State\",\"Texas Christian\",\"West Virginia\",\"Oklahoma State\",\"Texas Christian\",\"West Virginia\",\"Oklahoma State\",\"Texas Christian\",\"West Virginia\",\"Kansas State\",\"Texas Tech\",\"Oklahoma\",\"Texas\",\"Oklahoma\",\"Kansas State\",\"Texas Tech\",\"Texas\",\"Oklahoma\",\"Kansas State\",\"Texas Tech\",\"Texas\"],[\"Baylor\",\"Oklahoma\",\"Texas Tech\",\"Baylor\",\"Texas Tech\",\"Oklahoma\",\"Baylor\",\"Oklahoma\",\"Texas Tech\",\"Kansas State\",\"Oklahoma State\",\"Texas Christian\",\"Texas\",\"Kansas State\",\"Oklahoma State\",\"Texas Christian\",\"Texas\",\"Kansas State\",\"Oklahoma State\",\"Texas Christian\",\"Texas\",\"Kansas\",\"Texas Tech\",\"Oklahoma State\",\"Kansas State\",\"Kansas State\",\"Kansas\",\"Oklahoma State\",\"Texas Tech\",\"Kansas\",\"Oklahoma State\",\"Texas Tech\",\"Kansas State\",\"Baylor\",\"Texas Christian\",\"West Virginia\",\"Baylor\",\"Texas Christian\",\"Texas\",\"Baylor\",\"Texas\",\"West Virginia\",\"Texas Christian\",\"Texas\",\"West Virginia\",\"Kansas\",\"Oklahoma\",\"Baylor\",\"Oklahoma State\",\"Baylor\",\"Kansas\",\"Oklahoma\",\"Oklahoma State\",\"Kansas\",\"Oklahoma State\",\"Oklahoma\",\"Baylor\",\"Oklahoma State\",\"Kansas\",\"Texas\",\"Texas Tech\",\"West Virginia\",\"Texas Tech\",\"Kansas\",\"Texas\",\"Texas\",\"Texas Tech\",\"West Virginia\",\"Kansas\",\"West Virginia\",\"Kansas State\",\"Oklahoma\",\"Baylor\",\"Oklahoma\",\"Kansas State\",\"Texas Christian\",\"Baylor\",\"Kansas State\",\"Oklahoma\",\"Texas Christian\",\"Baylor\",\"Texas Christian\",\"Kansas\",\"West Virginia\",\"West Virginia\",\"Kansas\",\"Kansas\",\"West Virginia\",\"Oklahoma State\",\"Texas Christian\",\"West Virginia\",\"Oklahoma State\",\"Texas Christian\",\"West Virginia\",\"Oklahoma State\",\"Texas Christian\",\"West Virginia\",\"Kansas State\",\"Texas Tech\",\"Oklahoma\",\"Texas\",\"Oklahoma\",\"Kansas State\",\"Texas Tech\",\"Texas\",\"Oklahoma\",\"Kansas State\",\"Texas Tech\",\"Texas\"],[\"Kansas State\",\"Texas Christian\",\"Oklahoma State\",\"Kansas State\",\"Oklahoma State\",\"Texas Christian\",\"Kansas State\",\"Texas Christian\",\"Oklahoma State\",\"Oklahoma\",\"Baylor\",\"Kansas\",\"Texas Tech\",\"Oklahoma\",\"Baylor\",\"Kansas\",\"Texas Tech\",\"Oklahoma\",\"Baylor\",\"Kansas\",\"Texas Tech\",\"Baylor\",\"Texas Christian\",\"Texas\",\"West Virginia\",\"West Virginia\",\"Baylor\",\"Texas\",\"Texas Christian\",\"Baylor\",\"Texas\",\"Texas Christian\",\"West Virginia\",\"Oklahoma\",\"Oklahoma State\",\"Kansas\",\"Oklahoma\",\"Oklahoma State\",\"Kansas State\",\"Oklahoma\",\"Kansas State\",\"Kansas\",\"Oklahoma State\",\"Kansas State\",\"Kansas\",\"Kansas State\",\"Texas Tech\",\"Texas\",\"West Virginia\",\"Texas\",\"Kansas State\",\"Texas Tech\",\"West Virginia\",\"Kansas State\",\"West Virginia\",\"Texas Tech\",\"Texas\",\"Oklahoma\",\"Oklahoma State\",\"Oklahoma\",\"Baylor\",\"Texas Christian\",\"Baylor\",\"Oklahoma State\",\"Oklahoma\",\"Oklahoma\",\"Baylor\",\"Texas Christian\",\"Oklahoma State\",\"Texas Christian\",\"Texas Tech\",\"Kansas\",\"West Virginia\",\"Kansas\",\"Texas Tech\",\"Texas\",\"West Virginia\",\"Texas Tech\",\"Kansas\",\"Texas\",\"West Virginia\",\"Texas\",\"Texas\",\"Oklahoma\",\"Oklahoma\",\"Texas\",\"Texas\",\"Oklahoma\",\"Kansas State\",\"Baylor\",\"Texas Tech\",\"Kansas State\",\"Baylor\",\"Texas Tech\",\"Kansas State\",\"Baylor\",\"Texas Tech\",\"Texas Christian\",\"Kansas\",\"Oklahoma State\",\"West Virginia\",\"Oklahoma State\",\"Texas Christian\",\"Kansas\",\"West Virginia\",\"Oklahoma State\",\"Texas Christian\",\"Kansas\",\"West Virginia\"],[1,5,8,8,4,3,8,7,12,7,11,8,6,7,15,18,6,8,13,14,9,12,20,3,3,7,13,4,7,5,4,10,6,10,6,3,3,7,6,5,5,7,12,8,12,4,7,9,3,10,1,5,5,18,11,12,6,19,10,1,10,5,4,3,4,6,14,7,3,17,3,2,4,11,2,4,0,10,7,2,4,15,10,9,3,2,6,9,9,5,2,19,2,17,12,10,5,7,1,2,12,5,1,8,10,1,3,15,7],[8,13,7,4,9,1,4,5,1,1,9,6,2,6,8,5,5,7,2,0,8,4,16,5,8,1,6,1,10,4,3,5,10,6,7,5,6,3,5,3,6,10,5,2,3,5,13,11,6,9,6,9,9,21,6,2,7,8,15,2,1,4,6,14,6,9,9,4,8,7,2,8,5,6,5,8,10,8,4,3,18,7,4,3,6,6,7,3,10,1,5,5,1,2,2,4,3,6,3,13,2,0,8,7,4,11,4,1,3]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th>Date<\\/th>\\n      <th>Home_Field<\\/th>\\n      <th>home<\\/th>\\n      <th>away<\\/th>\\n      <th>home_score<\\/th>\\n      <th>away_score<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[4,5]},{\"name\":\"Date\",\"targets\":0},{\"name\":\"Home_Field\",\"targets\":1},{\"name\":\"home\",\"targets\":2},{\"name\":\"away\",\"targets\":3},{\"name\":\"home_score\",\"targets\":4},{\"name\":\"away_score\",\"targets\":5}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false,\"orderCellsTop\":true}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\nSummary statistics\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(baseball)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      Date             Home_Field            home               away          \n Min.   :2023-03-17   Length:109         Length:109         Length:109        \n 1st Qu.:2023-04-01   Class :character   Class :character   Class :character  \n Median :2023-04-16   Mode  :character   Mode  :character   Mode  :character  \n Mean   :2023-04-17                                                           \n 3rd Qu.:2023-05-01                                                           \n Max.   :2023-05-20                                                           \n   home_score       away_score    \n Min.   : 0.000   Min.   : 0.000  \n 1st Qu.: 4.000   1st Qu.: 3.000  \n Median : 7.000   Median : 6.000  \n Mean   : 7.394   Mean   : 5.963  \n 3rd Qu.:10.000   3rd Qu.: 8.000  \n Max.   :20.000   Max.   :21.000  \n```\n\n\n:::\n:::\n\n\n#### Modeling\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Construct factors for teams\nteams <- data.frame(\n  names = c(baseball$home, baseball$away) |>\n    unique() |>\n    sort() |>\n    factor()\n)\n\nbaseball <- baseball |>\n  mutate(\n    home = factor(home, levels = teams$names),\n    away = factor(away, levels = teams$names)\n  )\n\nX_h <- construct_matrix(baseball, \"home\")\nX_a <- construct_matrix(baseball, \"away\")\n```\n:::\n\n\nFit the model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nY <- c(baseball$home_score, \n       baseball$away_score)\n\nX <- rbind(\n  cbind(1, X_h, -X_a),\n  cbind(0, X_a, -X_h)\n)\nm <- lm(Y ~ 0 + X) # 0 removes intercept (so does -1) \nsummary(m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = Y ~ 0 + X)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-8.9329 -2.9293 -0.3731  2.2201 13.9119 \n\nCoefficients: (1 not defined because of singularities)\n    Estimate Std. Error t value Pr(>|t|)    \nX1    1.3951     0.5557   2.510 0.012857 *  \nX2    3.3262     1.1832   2.811 0.005429 ** \nX3    4.2627     1.1832   3.603 0.000398 ***\nX4    3.9188     1.1832   3.312 0.001100 ** \nX5    3.3672     1.1727   2.871 0.004529 ** \nX6    6.7411     1.1772   5.726 3.72e-08 ***\nX7    4.1092     1.1832   3.473 0.000631 ***\nX8    5.6595     1.1832   4.783 3.35e-06 ***\nX9    5.3685     1.1832   4.537 9.83e-06 ***\nX10   5.2415     1.2562   4.172 4.49e-05 ***\nX11  -3.0106     1.1933  -2.523 0.012421 *  \nX12  -3.1693     1.1933  -2.656 0.008549 ** \nX13  -1.4180     1.1933  -1.188 0.236145    \nX14  -1.4096     1.1814  -1.193 0.234227    \nX15  -0.8453     1.1814  -0.715 0.475168    \nX16   0.0582     1.1933   0.049 0.961150    \nX17  -0.6773     1.1933  -0.568 0.570997    \nX18  -1.3492     1.1933  -1.131 0.259574    \nX19       NA         NA      NA       NA    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 4.101 on 200 degrees of freedom\nMultiple R-squared:  0.7552,\tAdjusted R-squared:  0.7332 \nF-statistic: 34.29 on 18 and 200 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n\n#### Parameter estimates\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(home_advantage <- coef(m)[1])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X1 \n1.395062 \n```\n\n\n:::\n\n```{.r .cell-code}\n(sd             <- summary(m)$sigma)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 4.101447\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nratings <- data.frame(\n  team = rep(teams$names, times = 2),\n  type = rep(c(\"offense\", \"defense\"), each = nrow(teams)),\n  rating = coef(m)[-1]\n) |>\n  mutate(\n    rating = ifelse(is.na(rating), 0, rating),\n    rating = rating - mean(rating)\n  ) |>\n  pivot_wider(\n    names_from = type,\n    values_from = rating\n  ) |>\n  mutate(\n    strength = offense + defense\n  ) |>\n  arrange(desc(strength))\n\nratings |> \n  datatable(filter = \"top\", rownames = FALSE) |>\n  formatRound(columns = c('offense', 'defense', 'strength'),\n              digits = 2)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-510576ebc2d6b8a77870\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-510576ebc2d6b8a77870\">{\"x\":{\"filter\":\"top\",\"vertical\":false,\"filterHTML\":\"<tr>\\n  <td data-type=\\\"factor\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"width: 100%; display: none;\\\">\\n      <select multiple=\\\"multiple\\\" style=\\\"width: 100%;\\\" data-options=\\\"[&quot;Baylor&quot;,&quot;Kansas&quot;,&quot;Kansas State&quot;,&quot;Oklahoma&quot;,&quot;Oklahoma State&quot;,&quot;Texas&quot;,&quot;Texas Christian&quot;,&quot;Texas Tech&quot;,&quot;West Virginia&quot;]\\\"><\\/select>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"number\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"1.6498536736632\\\" data-max=\\\"5.06478089811424\\\" data-scale=\\\"15\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"number\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"-4.8456208694304\\\" data-max=\\\"-1.61810764191717\\\" data-scale=\\\"15\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n  <td data-type=\\\"number\\\" style=\\\"vertical-align: top;\\\">\\n    <div class=\\\"form-group has-feedback\\\" style=\\\"margin-bottom: auto;\\\">\\n      <input type=\\\"search\\\" placeholder=\\\"All\\\" class=\\\"form-control\\\" style=\\\"width: 100%;\\\"/>\\n      <span class=\\\"glyphicon glyphicon-remove-circle form-control-feedback\\\"><\\/span>\\n    <\\/div>\\n    <div style=\\\"display: none;position: absolute;width: 200px;opacity: 1\\\">\\n      <div data-min=\\\"-3.03703703703703\\\" data-max=\\\"2.54320987654323\\\" data-scale=\\\"15\\\"><\\/div>\\n      <span style=\\\"float: left;\\\"><\\/span>\\n      <span style=\\\"float: right;\\\"><\\/span>\\n    <\\/div>\\n  <\\/td>\\n<\\/tr>\",\"data\":[[\"Oklahoma State\",\"West Virginia\",\"Texas Christian\",\"Texas\",\"Texas Tech\",\"Kansas State\",\"Oklahoma\",\"Kansas\",\"Baylor\"],[5.064780898114243,3.565197589007103,3.983187006996524,2.432922456731982,3.692181715991233,2.242446266255794,1.690883190883196,2.586361610171132,1.649853673663203],[-2.521571021571017,-1.67630870011822,-2.353557377366899,-1.618107641917169,-3.025515049324574,-3.094298118107643,-3.085944919278255,-4.845620869430398,-4.686890710700235],[2.543209876543226,1.888888888888883,1.629629629629625,0.8148148148148135,0.6666666666666594,-0.8518518518518485,-1.395061728395059,-2.259259259259266,-3.037037037037032]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th>team<\\/th>\\n      <th>offense<\\/th>\\n      <th>defense<\\/th>\\n      <th>strength<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"targets\":1,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":2,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":3,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"className\":\"dt-right\",\"targets\":[1,2,3]},{\"name\":\"team\",\"targets\":0},{\"name\":\"offense\",\"targets\":1},{\"name\":\"defense\",\"targets\":2},{\"name\":\"strength\",\"targets\":3}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false,\"orderCellsTop\":true}},\"evals\":[\"options.columnDefs.0.render\",\"options.columnDefs.1.render\",\"options.columnDefs.2.render\"],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\nWe can compare these ratings to the \n[Big 12 standings from 2023](http://big12sports.com/standings.aspx?standings=190). \n\nLet's plot these ratings\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconstant <- 5\n\np_ratings <- ratings |>\n  mutate(\n    offense = offense   + constant,\n    defense = defense   + constant,\n    strength = offense + defense\n  ) |>\n  pivot_longer(\n    cols = offense:strength,\n    names_to = \"type\",\n    values_to = \"rating\"\n  ) |>\n  mutate(\n    team = factor(team, levels = ratings$team[order(ratings$strength)]),\n    type = factor(type, levels = c(\"offense\",\"defense\",\"strength\"))\n  )\n\nggplot(p_ratings,\n       aes(\n         x = rating,\n         y = team\n       )) +\n  geom_bar(stat=\"identity\") + \n  facet_wrap(~type, nrow = 1, scales = \"free_x\")\n```\n\n::: {.cell-output-display}\n![](offense-defense-rating_files/figure-html/baseball-ratings-plot-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(p_ratings |>\n        filter(type != \"strength\") |>\n         mutate(rating = rating - constant),\n       aes(\n         x = rating,\n         y = team,\n         fill = type\n       )) +\n  geom_bar(stat=\"identity\")\n```\n\n::: {.cell-output-display}\n![](offense-defense-rating_files/figure-html/ratings-alternative-plot-1.png){width=672}\n:::\n:::\n\n\n#### Predictions\n\nLet's suppose we are interested in calculating the probability in a \nhome-and-home series between Oklahoma and Oklahoma State. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nratings |> filter(team %in% c('Oklahoma','Oklahoma State'))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 4\n  team           offense defense strength\n  <fct>            <dbl>   <dbl>    <dbl>\n1 Oklahoma State    5.06   -2.52     2.54\n2 Oklahoma          1.69   -3.09    -1.40\n```\n\n\n:::\n\n```{.r .cell-code}\n# @ Oklahoma\n(expected_home <- home_advantage + \n    ratings$offense[ratings$team == \"Oklahoma\"] - \n    ratings$defense[ratings$team == \"Oklahoma State\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X1 \n5.607516 \n```\n\n\n:::\n\n```{.r .cell-code}\n(expected_away <- \n    ratings$offense[ratings$team == \"Oklahoma State\"] - \n    ratings$defense[ratings$team == \"Oklahoma\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 8.150726\n```\n\n\n:::\n\n```{.r .cell-code}\n(expected_margin <- expected_home - expected_away)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X1 \n-2.54321 \n```\n\n\n:::\n\n```{.r .cell-code}\n(probability_Oklahoma_win_home <- \n    pt(expected_margin / (sd * sqrt(2)), \n       df = summary(m)$df[2]))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X1 \n0.330763 \n```\n\n\n:::\n\n```{.r .cell-code}\n# @ Oklahoma State\n(expected_home <- home_advantage + \n    ratings$offense[ratings$team == \"Oklahoma State\"] - \n    ratings$defense[ratings$team == \"Oklahoma\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X1 \n9.545788 \n```\n\n\n:::\n\n```{.r .cell-code}\n(expected_away <- \n    ratings$offense[ratings$team == \"Oklahoma\"] - \n    ratings$defense[ratings$team == \"Oklahoma State\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 4.212454\n```\n\n\n:::\n\n```{.r .cell-code}\n(expected_margin <- expected_home - expected_away)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      X1 \n5.333333 \n```\n\n\n:::\n\n```{.r .cell-code}\n(probability_Oklahoma_win_away <- \n    1 - pt(expected_margin / (sd * sqrt(2)), # note the 1 -\n           df = summary(m)$df[2])) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       X1 \n0.1794737 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Probability Oklahoma wins both (assuming independence)\nprobability_Oklahoma_win_home * probability_Oklahoma_win_away\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        X1 \n0.05936325 \n```\n\n\n:::\n:::\n\n\n\n## Rating Systems\n\n### Kenpom.com\n\nKen Pomeroy provides the types of ratings at [kenpom.com](https://kenpom.com/) for D-I college basketball:\n\n- ORtg: offense rating\n- DRtg: defense rating\n- NetRtg: strength rating\n\nNote that NetRtg = ORtg - DRtg. \n\nRather than estimating the home court advantage, \n[these ratings assume a 3.75 points per game home court advantage](https://kenpom.com/blog/ratings-methodology-update/).\n\n",
    "supporting": [
      "offense-defense-rating_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../../site_libs/nouislider-7.0.10/jquery.nouislider.min.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/nouislider-7.0.10/jquery.nouislider.min.js\"></script>\n<link href=\"../../site_libs/selectize-0.12.0/selectize.bootstrap3.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/selectize-0.12.0/selectize.min.js\"></script>\n<link href=\"../../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}