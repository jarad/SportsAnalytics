# Offense-Defense Rating

```{r packages}
library("tidyverse"); theme_set(theme_bw())
```

A simple example of offense-defense data is this fictitious collection of 4 
teams that have played 5 games. 


```{r data}
d <- tribble(
  ~home, ~away, ~home_score, ~away_score, 
      1,     2,          21,           7,
      2,     3,          13,          14,
      4,     1,           3,          28,
      3,     4,          31,           0,
      1,     3,          42,          10
) 
```

Previously, we calculated the margin of victory (home score minus away score)
and constructed a model for the margin of victory. 
In those models, we estimated a team strength and used the difference in team
strengths to calculate the expected margin of victory and game outcome
probabilities. 

In this chapter, we will build models for the both the home score and the 
away score. 
Using the scores allows us to estimate offense and defense team strengths. 



## Model

A model for the number of points scored by the home team is 

$$S^H_g = \eta_O + \theta_{H[g]} - \delta_{A[g]} + \epsilon^H_g$$

where, for game $g$,

- $S^H_g$ is the score for the home team,
- $H[g]$ is the ID for the home team, 
- $A[g]$ is the ID for the away team,
- $\epsilon^H_g$ is a random error.

This error arises because if two teams play each other repeatedly we would 
expect the home score would be random around the expected
home score.

The parameters are 

- $\eta_O$ is the offensive home advantage, 
- $\theta_t$ is the offensive strength of team $t$, and
- $\delta_t$ is the defense strength of team $t$.

The expected home score when team $H$ is at home playing against team $A$ is 

$$E\left[S^H\right] = \eta_O + \theta_{H} - \delta_{A}.$$
We can build a similar model for the away team score. 
A model for the number of points scored by the away team is 

$$S^A_g = \eta_D + \theta_{A[g]} - \delta_{H[g]} + \epsilon^A_g$$

where, for game $g$,

- $S^A_g$ is the score for the away team,
- $\epsilon^A_g$ is a random error.

This error arises because if two teams play each other repeatedly we would 
expect the away score would be random around the expected
away score.

The parameters are 

- $\eta_D$ is the defensive home advantage.

The expected away score when team $H$ is at home playing against team $A$ is 

$$E\left[S^A\right] = \eta_D + \theta_{A} - \delta_{H}.$$

We can utilize these models to calculate the expected margin of victory $M$ for 
home team $H$ playing away team $A$:
$$\begin{array}{rl} 
E[M] 
&= E[S^H - S^A] \\
&= E[S^H] - E[S^A] \\
&= \eta_O + \theta_H - \delta_A - (\eta_D + \theta_A - \delta_H) \\
&= (\eta_O - \eta_D) + (\theta_H + \delta_H) - (\theta_A + \delta_A) 
\end{array}
$$
where 

- $\eta_O - \eta_D$ is the home advantage,
- $\theta_H - \delta_H$ is the strength of the home team, and
- $\theta_A - \delta_A$ is the strength of the away team.



### Identifiability

In this model, 
when two teams play each other, the score is expected to be the 
home advantage $\eta$ plus the difference in strengths between the two
teams $\theta - \delta$.
Thus, only the difference between the offense and defense rating is identifiable.




### Regression


If we assume $\epsilon_i \stackrel{ind}{\sim} N(0,\sigma^2)$,
then this is a linear regression model. 

Since we have both the offensive parameters ($\theta$s) and defensive 
parameters ($\delta$s), 
we will need to construct a home matrix $X^H$ and an away matrix $X^A$. 
For $X^H$ we have 
$$X^H_{g,t} = \left\{
\begin{array}{rl}
1 & \mbox{if team $t$ is the home team in game $g$} \\
0 & \mbox{otherwise}
\end{array} \right.$$


For the analysis that follows, 
we will construct a model matrix $X$ where 
$X_{g,t} = 1$ if team $t$ is the home team in game $g$,  
$X_{g,t} = -1$ if team $t$ is the away team in game $g$,
$X_{g,t} = 0$ otherwise.

```{r model-matrix}
construct_matrix <- function(d, Col = "home") {
  n_games <- nrow(d)
  n_teams <- length(unique(unlist(d[, Col])))
  
  m <- matrix(0, 
              nrow = n_games, 
              ncol = n_teams)
  
  for (g in 1:n_games) {
    m[g, as.numeric(d[g, Col])] <-  1
  }
  
  return(m)
}

X_h <- construct_matrix(d, "home")
X_a <- construct_matrix(d, "away")
```

Check to make sure these matrices are appropriate

```{r check-matrices}
# n_games x n_teams
dim(X_h) 
dim(X_a) 

# all entries are 0 or 1
all(unique(X_h) %in% 0:1) 
all(unique(X_a) %in% 0:1)

all(rowSums(X_h) == 1)
all(rowSums(X_a) == 1)
```



To see how it is a linear regression model, 
we can construct a regression model using matrix algebra
$$
Y = \left[ \begin{array}{c} 
S^H_1 \\ \vdots \\ S^H_G \\
S^A_1 \\ \vdots \\ S^A_G 
\end{array} \right] 
= \left[ \begin{array}{cc} 
1 & X_h & 0 & -X_a \\ 0 & X_a & 1 & -X_h
\end{array} \right] 
\left[ \begin{array}{c} 
\eta^O \\ \theta_1 \\ \vdots \\ \theta_T \\
\eta^D \\ \delta_1 \\ \vdots \\ \delta_T 
\end{array} \right] + \epsilon 
= X\beta + \epsilon
$$
where $1$ ($0$) is shorthand for a $G \times 1$ vector of all 1s (0s). 



Thus, we can estimate the parameters in this model using linear regression.

```{r regression}
Y <- c(d$home_score, d$away_score)
X <- rbind(
  cbind (1, X_h, -X_a),
  cbind(-1, X_a, -X_h)
)
m <- lm(Y ~ 0 + X) # 0 removes intercept (so does -1) 
summary(m)
```

```{r offense-defense-rating}
home_advantage <- coef(m)[1]

teams <- data.frame(
  team = rep(1:4, times = 2),
  type = rep(c("offense", "defense"), each = 4),
  rating = coef(m)[-1]
) |>
  mutate(
    rating = ifelse(is.na(rating), 0, rating),
    rating = rating - mean(rating)
  ) |>
  pivot_wider(
    names_from = type,
    values_from = rating
  ) |>
  mutate(
    strength = offense + defense
  )
```


### Prediction

Let $S^H$ ($S^A$) be the score for the home (away) team in an upcoming game. 
The regression model assumes
$$
S^H \sim N(\eta_O + \theta_H - \delta_A, \sigma^2) 
\quad \mbox{and (independently)} \quad 
S^A \sim N(\eta_D + \theta_A - \delta_H, \sigma^2). 
$$
Thus, the margin of victory $M$ is 
$$
M = S^H - S^A \sim N(E[M], 2\sigma^2)
$$
where $E[M]$ is given above. 
To find the probability the home team wins we use 
$$P(M > 0) 
= P\left( T_v > \frac{-E[M]}{\sigma\sqrt{2}} \right) 
= P\left( T_v < \frac{ E[M]}{\sigma\sqrt{2}} \right)
$$
where $T_v$ is a T-distribution with $v$ is the degrees of freedom.
The degrees of freedom can be calculated using $v = n-p$ 
with $n$ is the number of games times 2 (due to home and away scores being used)
and $p$ is the number of teams times 2 (due to estimating offense and defense
ratings). 

If $n >> p$ (which is certainly not true in our simple example), 
then $T_v \stackrel{d}{\sim} Z$ 
(where $\stackrel{d}{\sim}$ means approximately equal in distribution).
Thus, we can calculate the probability using
$$
P(M > 0) \approx P\left( Z < \frac{ E[M]}{\sigma\sqrt{2}} \right).
$$

The standard deviation here is 

```{r predictive_sd}
(sd <- summary(m)$sigma * sqrt(2))
```


Suppose Team 1 plays against Team 2 at Team 1's home. 

```{r probability}
# Margin of Victory: Team 1 (Home) - Team 2 (Away)
expected_margin <- as.numeric(coef(m)[1] + 
                                teams[1, "strength"] - 
                                teams[2, "strength"]) 

# Probability of Victory: Team 1 (Home) - Team 2 (Away)
pt(expected_margin / sd, df = summary(m)$df[2])
```


## Examples

### Baseball


```{r baseball-data}
baseball <- read.csv("../../data/college_baseball_2024.csv") |>
  
  # Create home/away teams and scores
  # for neutral sites, home/away will be arbitrary
  mutate(
    Home_Field = gsub("@", "", Home_Field),
    home_is_Team_1 =                        # this is used repeatedly below
      Home_Field == "neutral" | 
        Home_Field == Team_1,  
    
    # Set the teams
    home = ifelse(home_is_Team_1, Team_1, Team_2),
    away = ifelse(home_is_Team_1, Team_2, Team_1),
    
    # Set the scores
    home_score = ifelse(home_is_Team_1, Score_1, Score_2),
    away_score = ifelse(home_is_Team_1, Score_2, Score_1),
    
    Date = as.Date(Dates, format = "%m/%d/%Y")
  ) |>
  filter(Home_Field != "neutral") |>
  select(Date, Home_Field, home, away, home_score, away_score)
```

```{r baseball-construct-model-matrix}
# Construct factors for teams
teams <- data.frame(
  names = c(baseball$home, baseball$away) |>
    unique() |>
    sort() |>
    factor()
)

baseball <- baseball |>
  mutate(
    home = factor(home, levels = teams$names),
    away = factor(away, levels = teams$names)
  )

X_h <- construct_matrix(baseball, "home")
X_a <- construct_matrix(baseball, "away")
```

Fit the model

```{r}
Y <- c(baseball$home_score, 
       baseball$away_score)

X <- rbind(
  cbind( 1, X_h, -X_a),
  cbind(-1, X_a, -X_h)
)
m <- lm(Y ~ 0 + X) # 0 removes intercept (so does -1) 
summary(m)
```

```{r teams}
home_advantage <- coef(m)[1]
sd             <- summary(m)$sigma

ratings <- data.frame(
  team = rep(teams$names, times = 2),
  type = rep(c("offense", "defense"), each = nrow(teams)),
  rating = coef(m)[-1]
) |>
  mutate(
    rating = ifelse(is.na(rating), 0, rating),
    rating = rating - mean(rating)
  ) |>
  pivot_wider(
    names_from = type,
    values_from = rating
  ) |>
  mutate(
    strength = offense + defense
  ) |>
  arrange(desc(strength))
```



### Iowa Football

